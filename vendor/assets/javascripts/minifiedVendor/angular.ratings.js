// Generated by CoffeeScript 1.3.3
var app;

app = angular.module('ratings', []);

app.directive("angularRatings", function() {
    return {
        restrict: 'A',
        scope: {
            model: '=ngModel',
            trackableId: '=trackableId',
            trackableType: '=trackableType',
            userId:'=userId',
            ratingUserId:'=ratingUserId'
        },
        replace: true,
        transclude: true,
        template: '<div><ol class="angular-ratings">' + '<li ng-class="{active:model>0,over:over>0}">1</li>' + '<li ng-class="{active:model>1,over:over>1}">2</li>' + '<li ng-class="{active:model>2,over:over>2}">3</li>' + '<li ng-class="{active:model>3,over:over>3}">4</li>' + '<li ng-class="{active:model>4,over:over>4}">5</li>' + '</ol></div>',
        controller: function($scope, $attrs, $http) {
            $scope.over = 0;
            $scope.setRating = function(rating) {

                if($scope.userId!=$scope.ratingUserId){

                    $scope.model = rating;
                    $scope.$apply();
                    if ($attrs.notifyUrl !== void 0 && ($scope.trackableId && $scope.trackableType)) {
                        return $http.post($attrs.notifyUrl, {
                            trackable_id: $scope.trackableId,
                            trackable_type:$scope.trackableType,
                            rating: rating
                        }).error(function(data) {
                                if (typeof data === 'string') {
                                    alert(data);
                                }
                                return $scope.model = 0;
                            });
                    }
                }
                else{
                    alert("You have already rated");
                    return
                }
            };
            return $scope.setOver = function(n) {
                $scope.over = n;
                return $scope.$apply();
            };
        },
        link: function(scope, iElem, iAttrs) {
            if (iAttrs.notifyUrl !== void 0) {
                return angular.forEach(iElem.children(), function(ol) {
                    return angular.forEach(ol.children, function(li) {
                        li.addEventListener('mouseover', function() {
                            return scope.setOver(parseInt(li.innerHTML));
                        });
                        li.addEventListener('mouseout', function() {
                            return scope.setOver(0);
                        });
                        return li.addEventListener('click', function() {
                            return scope.setRating(parseInt(li.innerHTML));
                        });
                    });
                });
            }
        }
    };
});
